{"version":3,"file":"directive_normalizer.js","sourceRoot":"","sources":["../../../../../modules/@angular/compiler/src/directive_normalizer.ts"],"names":[],"mappings":"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","sourcesContent":["import {Injectable, ViewEncapsulation} from '@angular/core';\n\nimport {isPresent} from '../src/facade/lang';\nimport {BaseException} from '../src/facade/exceptions';\nimport {PromiseWrapper} from '../src/facade/async';\n\nimport {\n  CompileTypeMetadata,\n  CompileDirectiveMetadata,\n  CompileTemplateMetadata,\n} from './compile_metadata';\nimport {XHR} from './xhr';\nimport {UrlResolver} from './url_resolver';\nimport {extractStyleUrls, isStyleUrlResolvable} from './style_url_resolver';\n\nimport {\n  HtmlAstVisitor,\n  HtmlElementAst,\n  HtmlTextAst,\n  HtmlAttrAst,\n  HtmlCommentAst,\n  HtmlExpansionAst,\n  HtmlExpansionCaseAst,\n  htmlVisitAll\n} from './html_ast';\nimport {HtmlParser} from './html_parser';\n\nimport {preparseElement, PreparsedElementType} from './template_preparser';\nexport class DirectiveNormalizer {\n/**\n * @param {?} _xhr\n * @param {?} _urlResolver\n * @param {?} _htmlParser\n */\nconstructor(private _xhr: XHR,\nprivate _urlResolver: UrlResolver,\nprivate _htmlParser: HtmlParser) {}\n/**\n * @param {?} directive\n * @return {?}\n */\nnormalizeDirective(directive: CompileDirectiveMetadata): Promise<CompileDirectiveMetadata> {\n    if (!directive.isComponent) {\n      // For non components there is nothing to be normalized yet.\n      return PromiseWrapper.resolve(directive);\n    }\n    return this.normalizeTemplate(directive.type, directive.template)\n        .then((normalizedTemplate: CompileTemplateMetadata) => new CompileDirectiveMetadata({\n                type: directive.type,\n                isComponent: directive.isComponent,\n                selector: directive.selector,\n                exportAs: directive.exportAs,\n                changeDetection: directive.changeDetection,\n                inputs: directive.inputs,\n                outputs: directive.outputs,\n                hostListeners: directive.hostListeners,\n                hostProperties: directive.hostProperties,\n                hostAttributes: directive.hostAttributes,\n                lifecycleHooks: directive.lifecycleHooks,\n                providers: directive.providers,\n                viewProviders: directive.viewProviders,\n                queries: directive.queries,\n                viewQueries: directive.viewQueries,\n                template: normalizedTemplate\n              }));\n  }\n/**\n * @param {?} directiveType\n * @param {?} template\n * @return {?}\n */\nnormalizeTemplate(directiveType: CompileTypeMetadata,\n                    template: CompileTemplateMetadata): Promise<CompileTemplateMetadata> {\n    if (isPresent(template.template)) {\n      return PromiseWrapper.resolve(this.normalizeLoadedTemplate(\n          directiveType, template, template.template, directiveType.moduleUrl));\n    } else if (isPresent(template.templateUrl)) {\n      var /** @type {?} */ sourceAbsUrl = this._urlResolver.resolve(directiveType.moduleUrl, template.templateUrl);\n      return this._xhr.get(sourceAbsUrl)\n          .then(templateContent => this.normalizeLoadedTemplate(directiveType, template,\n                                                                templateContent, sourceAbsUrl));\n    } else {\n      throw new BaseException(`No template specified for component ${directiveType.name}`);\n    }\n  }\n/**\n * @param {?} directiveType\n * @param {?} templateMeta\n * @param {?} template\n * @param {?} templateAbsUrl\n * @return {?}\n */\nnormalizeLoadedTemplate(directiveType: CompileTypeMetadata, templateMeta: CompileTemplateMetadata,\n                          template: string, templateAbsUrl: string): CompileTemplateMetadata {\n    var /** @type {?} */ rootNodesAndErrors = this._htmlParser.parse(template, directiveType.name);\n    if (rootNodesAndErrors.errors.length > 0) {\n      var /** @type {?} */ errorString = rootNodesAndErrors.errors.join('\\n');\n      throw new BaseException(`Template parse errors:\\n${errorString}`);\n    }\n\n    var /** @type {?} */ visitor = new TemplatePreparseVisitor();\n    htmlVisitAll(visitor, rootNodesAndErrors.rootNodes);\n    var /** @type {?} */ allStyles = templateMeta.styles.concat(visitor.styles);\n\n    var /** @type {?} */ allStyleAbsUrls =\n        visitor.styleUrls.filter(isStyleUrlResolvable)\n            .map(url => this._urlResolver.resolve(templateAbsUrl, url))\n            .concat(templateMeta.styleUrls.filter(isStyleUrlResolvable)\n                        .map(url => this._urlResolver.resolve(directiveType.moduleUrl, url)));\n\n    var /** @type {?} */ allResolvedStyles = allStyles.map(style => {\n      var /** @type {?} */ styleWithImports = extractStyleUrls(this._urlResolver, templateAbsUrl, style);\n      styleWithImports.styleUrls.forEach(styleUrl => allStyleAbsUrls.push(styleUrl));\n      return styleWithImports.style;\n    });\n\n    var /** @type {?} */ encapsulation = templateMeta.encapsulation;\n    if (encapsulation === ViewEncapsulation.Emulated && allResolvedStyles.length === 0 &&\n        allStyleAbsUrls.length === 0) {\n      encapsulation = ViewEncapsulation.None;\n    }\n    return new CompileTemplateMetadata({\n      encapsulation: encapsulation,\n      template: template,\n      templateUrl: templateAbsUrl,\n      styles: allResolvedStyles,\n      styleUrls: allStyleAbsUrls,\n      ngContentSelectors: visitor.ngContentSelectors\n    });\n  }\n\n  static _tsickle_typeAnnotationsHelper() {\n /** @type {?} */\nDirectiveNormalizer.prototype._xhr;\n /** @type {?} */\nDirectiveNormalizer.prototype._urlResolver;\n /** @type {?} */\nDirectiveNormalizer.prototype._htmlParser;\n  }\n\nstatic decorators: DecoratorInvocation[] = [\n{ type: Injectable },\n];\nstatic ctorParameters: {type: Function, decorators?: DecoratorInvocation[]}[] = [\n{type: XHR, },\n{type: UrlResolver, },\n{type: HtmlParser, },\n];\n}\n\nclass TemplatePreparseVisitor implements HtmlAstVisitor {\n  ngContentSelectors: string[] = [];\n  styles: string[] = [];\n  styleUrls: string[] = [];\n  ngNonBindableStackCount: number = 0;\n/**\n * @param {?} ast\n * @param {?} context\n * @return {?}\n */\nvisitElement(ast: HtmlElementAst, context: any): any {\n    var /** @type {?} */ preparsedElement = preparseElement(ast);\n    switch (preparsedElement.type) {\n      case PreparsedElementType.NG_CONTENT:\n        if (this.ngNonBindableStackCount === 0) {\n          this.ngContentSelectors.push(preparsedElement.selectAttr);\n        }\n        break;\n      case PreparsedElementType.STYLE:\n        var /** @type {?} */ textContent = '';\n        ast.children.forEach(child => {\n          if (child instanceof HtmlTextAst) {\n            textContent += ( /** @type {?} */((<HtmlTextAst>child))).value;\n          }\n        });\n        this.styles.push(textContent);\n        break;\n      case PreparsedElementType.STYLESHEET:\n        this.styleUrls.push(preparsedElement.hrefAttr);\n        break;\n      default:\n        // DDC reports this as error. See:\n        // https://github.com/dart-lang/dev_compiler/issues/428\n        break;\n    }\n    if (preparsedElement.nonBindable) {\n      this.ngNonBindableStackCount++;\n    }\n    htmlVisitAll(this, ast.children);\n    if (preparsedElement.nonBindable) {\n      this.ngNonBindableStackCount--;\n    }\n    return null;\n  }\n/**\n * @param {?} ast\n * @param {?} context\n * @return {?}\n */\nvisitComment(ast: HtmlCommentAst, context: any): any { return null; }\n/**\n * @param {?} ast\n * @param {?} context\n * @return {?}\n */\nvisitAttr(ast: HtmlAttrAst, context: any): any { return null; }\n/**\n * @param {?} ast\n * @param {?} context\n * @return {?}\n */\nvisitText(ast: HtmlTextAst, context: any): any { return null; }\n/**\n * @param {?} ast\n * @param {?} context\n * @return {?}\n */\nvisitExpansion(ast: HtmlExpansionAst, context: any): any { return null; }\n/**\n * @param {?} ast\n * @param {?} context\n * @return {?}\n */\nvisitExpansionCase(ast: HtmlExpansionCaseAst, context: any): any { return null; }\n\n  static _tsickle_typeAnnotationsHelper() {\n /** @type {?} */\nTemplatePreparseVisitor.prototype.ngContentSelectors;\n /** @type {?} */\nTemplatePreparseVisitor.prototype.styles;\n /** @type {?} */\nTemplatePreparseVisitor.prototype.styleUrls;\n /** @type {?} */\nTemplatePreparseVisitor.prototype.ngNonBindableStackCount;\n  }\n\n}\n\ninterface DecoratorInvocation {\n  type: Function;\n  args?: any[];\n}\n"]}